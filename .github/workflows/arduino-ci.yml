name: Arduino CI

on:
  push:
    branches: [ main, add-bdc, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      
    - name: Install ESP32 platform
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
        
    - name: Install required libraries
      run: |
        arduino-cli lib install "EasyNextionLibrary"
        arduino-cli lib install "MAX6675 library"
        arduino-cli lib install "SimpleTimer"
        arduino-cli lib install "AutoPID"
        arduino-cli lib install "ESP32Servo"
        arduino-cli lib install "AUnit"
        
    - name: Compile main firmware
      run: |
        cd roaster-firmware
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware.ino --warnings all
        
    - name: Check firmware size
      run: |
        cd roaster-firmware
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware.ino | grep "Sketch uses"
        
    - name: Compile profile tests
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/test_profiles/test_profiles.ino
        
    - name: Compile PID tests
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/test_pid/test_pid.ino
        
    - name: Compile state machine tests
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/test_state_machine/test_state_machine.ino
        
    - name: Compile safety tests
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/test_safety/test_safety.ino
        
    - name: Compile unit test runner
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/unit_tests/unit_tests.ino
        
    - name: Compile hardware validation tests
      run: |
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/tests/hardware_validation/hardware_validation.ino
        
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-builds
        path: |
          roaster-firmware/build/
        retention-days: 30
        
    - name: Generate build report
      run: |
        echo "# Build Report" > build-report.md
        echo "" >> build-report.md
        echo "## Main Firmware" >> build-report.md
        cd roaster-firmware
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware.ino | grep -E "(Sketch|Global)" >> ../build-report.md || true
        cd ..
        echo "" >> build-report.md
        echo "## Test Suites Compiled" >> build-report.md
        echo "- ✓ test_profiles.ino" >> build-report.md
        echo "- ✓ test_pid.ino" >> build-report.md
        echo "- ✓ test_state_machine.ino" >> build-report.md
        echo "- ✓ test_safety.ino" >> build-report.md
        echo "- ✓ unit_tests.ino" >> build-report.md
        echo "- ✓ hardware_validation.ino" >> build-report.md
        cat build-report.md
        
    - name: Upload build report
      uses: actions/upload-artifact@v4
      with:
        name: build-report
        path: build-report.md
        retention-days: 30

  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Arduino Lint
      uses: arduino/arduino-lint-action@v1
      with:
        path: roaster-firmware
        library-manager: update
        compliance: specification
        
  size-report:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1
      
    - name: Install ESP32 platform
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
        arduino-cli core update-index
        arduino-cli core install esp32:esp32
        
    - name: Install libraries
      run: |
        arduino-cli lib install "EasyNextionLibrary"
        arduino-cli lib install "MAX6675 library"
        arduino-cli lib install "SimpleTimer"
        arduino-cli lib install "AutoPID"
        arduino-cli lib install "ESP32Servo"
        
    - name: Generate size report
      run: |
        cd roaster-firmware
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware.ino --output-dir ../build-output
        cd ..
        echo "# Firmware Size Report" > size-report.md
        echo "" >> size-report.md
        echo "Generated: $(date)" >> size-report.md
        echo "" >> size-report.md
        arduino-cli compile --fqbn esp32:esp32:nano_nora roaster-firmware/roaster-firmware.ino | grep -A 5 "Sketch uses" >> size-report.md || echo "Size information not available" >> size-report.md
        cat size-report.md
        
    - name: Upload size report
      uses: actions/upload-artifact@v4
      with:
        name: size-report
        path: size-report.md
        retention-days: 90

  # Future: Hardware-in-the-loop testing with self-hosted runner
  # hardware-tests:
  #   runs-on: self-hosted
  #   needs: build
  #   if: github.ref == 'refs/heads/main'
  #   
  #   steps:
  #   - name: Checkout repository
  #     uses: actions/checkout@v3
  #     
  #   - name: Flash test firmware
  #     run: |
  #       arduino-cli upload -p /dev/ttyUSB0 --fqbn esp32:esp32:nano_nora roaster-firmware/tests/unit_tests.ino
  #       
  #   - name: Run tests and capture output
  #     run: |
  #       timeout 300 arduino-cli monitor -p /dev/ttyUSB0 -c baudrate=115200 > test-results.log
  #       
  #   - name: Parse test results
  #     run: |
  #       python scripts/parse_test_results.py test-results.log
  #       
  #   - name: Upload test results
  #     uses: actions/upload-artifact@v3
  #     with:
  #       name: hardware-test-results
  #       path: test-results.log
